## Services

Как опубликовать приложение из кластера куба наружу?

![15.1 services.png](img/15.1%20services.png)
- !!Чтобы любой сервис работал, его селектор должен совпадать с лейблами подов, т.е. с теми подами, куда нужно отправлять траффик
- !!Поды и сервисы должны находится в одном неймспейсе

### ClusterIP
![15.2 services.png](img/15.2%20services.png)
Внктрикластерное взаимодействие

Это тип сервиса, чтоб наладить внутрикластерное взаимодействие частей нашего приложения - 
фронт связать в беком, например. Чисто технически, мы могли бы узанть ip наших подов и расскать, как к ним попадать. Но 
это будет работать ровно до тех пор, пока под не рестартанет, т.к. ip при этом изменится

### NodePort
![15.3 services.png](img/15.3%20services.png)
Если нам нужно наружу кинуть какой-то порт и его слушать и с него трансиловать в кластер

Вот с помощью этого сервиса уже можно опубликовать свою прилу наружу. Для этого и используется, но с небольшой оговоркой. 
Мы видим, что на каждой ноде у нас есть надпись порт и вот после этого идет траффик через наш сервис 
в наши поды. Он работает так, на каждой ноде будет указан порт, на который приходящий траффик снаружи будет попадать 
в наши поды. Эти порты открываются из особенного диапазона - 30_000 до 32_676. Это не очень удобно, т.к. 
теперь всем своим потреьителям надо рассказывать, что мы работает на 30_000-м порту. На самом деле этот сревис 
используют когда
- у нас снаружи стоит балансировщик, снаружи кластера и тогда на нем рассказать о портах. Тогда, например запросы приходящие на 
/catalogs, балансировщик будет переправлять на известный ему порт - 30_000
- используется в работе loadBalancer - следующий слайд

### LoadBalancer
![15.4 services.png](img/15.4%20services.png)
Отличный способ аубликовать приложение, но работает в облаках онли


Используется приемущественно у облачных провайдеров. У облачных провайдеров есть контроллер, который 
постоянно смотрит в куб и монирит создание сервисов LoadBalancer и когда этот сервис создается в кластере 
он у себя создает балансировщик. Этот балансирощик принимает траффик снаруди и переправляет его внутрь кластера. 
И вот загвоздка в том, что этот балансировщий создается при помоши контроллера, и если контроллера нет, 
то есть функциональности, которая умеет смотреть внутрь кластре куба и мониторить сервисы LoadBalancer 
то и магии никакой не произойдет

### ExternalName
![15.5 services.png](img/15.5%20services.png)
Хитрая переадресация

Обратить внимание, что стрелки на картинке направлены от подов к сервису. Работает так: когда мы из пода 
обращается в серсису по его имени - my-service, то мы попадаем на example.com

### ExternalIPs
![15.6 services.png](img/15.6%20services.png)
похож на nodePort, но по ip

Похоже на NodePort, только вместо портов, тут ip. Собственно и работа будет похожа - трафик прихоядший на некий ip 
будет транслироваться в наши поды. 


### Headless
![15.7 services.png](img/15.7%20services.png)

Сервис стоит особняком, т.к. он и не для внутрикластерного взаимодействия и не для публикации. 

Отличительная особенность - у него поле ClusterIP: none - гвоздями приколочено. Это значит у данного сервиса не будет 
создан ip, но будет создан dns по имени сервиса - my-service. И если мы сделаем запрос -- nslookup по нашему сервису, мы 
получим все ip-адреса подов, которые стоят за этим сервисом. Более того, мы даже сможем обратиться к конкретному поду 
имяСервиса.имя-пода. 
Используется в стейт-фулл сервисах. Все поды будут иметь префикс - 0, 1, 2... И мы может настроить репликацию - 
0-мастер, другие-slave


### Итого
Сервисы это прокси? Нет, это не какие-то физические обхекты. Это по сути IP-Tables. При создании сервиса на 
всех нодах кластера создается правило, мол при оращении надо роутить. + На данном этпе, если подв у нас два, 
то там функция, которая будет рандомно выбирать, на какой из двух додов, т.е. в данном случа с вероятность в 50%. Если 
пода станет три, то и процент изменится на 33%

![15.8 services.png](img/15.8%20services.png)
Service это
- Статический IP который ему выдается при создании объекта
- DNS имя, которое присваивается на этот IP
- правила it-tables для роутинга
- сервис это не прокси